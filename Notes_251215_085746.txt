Trid

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø¨Ø§Øª ØªØ±ÛŒØ¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <!-- Tailwind CSS CDN - Ø§ÛŒÙ† Ø®Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§ÛŒÙ„â€ŒØ¯Ù‡ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª Ùˆ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ù‡Ø§Ø³Øª Ù…Ø¬Ø²Ø§ Ù„ÙˆØ¯ Ø´ÙˆØ¯. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #111827; /* Dark Background */
            color: #e5e7eb; /* Light text */
        }
        .btn-primary {
            background-color: #4f46e5; 
            color: white; 
            font-weight: 900;
            padding: 12px 32px; 
            border-radius: 1rem; 
            transition: all 0.3s; 
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3), 0 4px 6px -2px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.5);
            transform: scale(1.02);
        }
        .card {
            background-color: #374151; /* Gray-700 */
            border-radius: 1rem; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.25); 
            padding: 1.5rem; 
            border: 1px solid #4b5563; /* Gray-600 */
        }
        input[type="text"], input[type="number"], select {
            background-color: #1f2937; /* Gray-800 */
            border-color: #4b5563; 
            color: #e5e7eb;
            border-width: 1px;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
        }
        /* Loader styles for spinner */
        .spinner-border {
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
        }
        #symbol-suggestions {
            z-index: 100;
            position: absolute;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 1.5rem); 
            left: 0.75rem;
            right: 0.75rem;
        }
    </style>
</head>
<body class="p-4">

    <!-- Container for the entire application -->
    <div id="app" class="max-w-4xl mx-auto bg-gray-800 rounded-3xl p-6 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-black text-white mb-2 tracking-tight">ğŸ¤– Ø±Ø¨Ø§Øª ØªØ±ÛŒØ¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ <span class="text-indigo-500">(M30 Scalp)</span></h1>
            <p class="text-gray-400 text-sm">ØªØ­Ù„ÛŒÙ„ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø§ ØªÙ…Ø±Ú©Ø² Ø¨Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©Ø§Ù„Ù¾ Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ.</p>
        </header>

        <!-- Control Panel and Configuration -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 bg-gray-900 p-4 rounded-2xl mb-6 shadow-inner">
            
            <!-- Asset Search Input -->
            <div class="relative col-span-2 md:col-span-1">
                <label for="asset-symbol" class="block text-xs font-medium text-gray-300">Ù†Ù…Ø§Ø¯:</label>
                <input type="text" id="asset-symbol" value="XAUUSD" 
                       class="mt-1 block w-full text-left uppercase text-sm" 
                       dir="ltr" oninput="handleSearchInput(this.value)" onfocus="handleSearchInput(this.value)" onblur="setTimeout(() => document.getElementById('symbol-suggestions').classList.add('hidden'), 200)">
                <div id="symbol-suggestions" class="hidden absolute w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-xl overflow-hidden"></div>
            </div>
            
            <!-- Timeframe Selector (Fixed to M30 for Scalp) -->
            <div>
                <label for="timeframe-select" class="block text-xs font-medium text-gray-300">ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…:</label>
                <select id="timeframe-select" class="mt-1 block w-full text-sm">
                    <option value="M30" selected>30 Ø¯Ù‚ÛŒÙ‚Ù‡ (M30)</option>
                    <option value="H1">1 Ø³Ø§Ø¹Øª (H1)</option>
                    <option value="H4">4 Ø³Ø§Ø¹Øª (H4)</option>
                </select>
            </div>

            <div>
                <label for="rsi-period" class="block text-xs font-medium text-gray-300">Ø¯ÙˆØ±Ù‡ RSI:</label>
                <input type="number" id="rsi-period" value="14" min="1" class="mt-1 block w-full text-center text-sm">
            </div>

            <div>
                <label for="risk-percent" class="block text-xs font-medium text-gray-300">Ø±ÛŒØ³Ú© (%):</label>
                <input type="number" id="risk-percent" value="1.5" min="0.1" max="5" step="0.1" class="mt-1 block w-full text-center text-sm">
            </div>
            
            <!-- Run Button -->
            <button id="run-button" onclick="runBot()" class="btn-primary w-full md:mt-auto flex items-center justify-center space-x-2 space-x-reverse h-full min-h-[40px] col-span-2 md:col-span-1 text-sm">
                <span id="button-text">Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ§Ù‚Ø¹ÛŒ</span>
                <div id="loader" class="hidden spinner-border h-4 w-4" role="status">
                    <svg class="animate-spin -ml-1 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </button>
        </div>
        
        <!-- Previous Signals Card -->
        <div id="history-card" class="card mb-6 bg-amber-900 border-amber-600 hidden">
            <h2 class="text-xl font-black mb-3 text-center text-amber-300">âŒ› Ø³ÙˆØ§Ø¨Ù‚ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ </h2>
            <div id="history-display" class="grid grid-cols-2 md:grid-cols-6 gap-3"></div>
        </div>

        <!-- Initial Message -->
        <div id="initial-message" class="text-center p-8 bg-gray-700 rounded-xl text-indigo-300 shadow-md">
            <p class="text-lg font-bold">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ØŒ Ù†Ù…Ø§Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.</p>
        </div>

        <!-- Trade Recommendation Card (Visible on signal) -->
        <div id="recommendation-card" class="hidden card mb-6">
            <h2 class="text-2xl font-black mb-2 text-center text-white">ğŸ”¥ ØªÙˆØµÛŒÙ‡ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ğŸ”¥</h2>
            <div id="scalping-signal-display" class="text-md text-center font-medium mb-3 p-2 rounded-lg bg-gray-900 text-indigo-400"></div>
            
            <div id="signal-display" class="p-3 text-white rounded-xl mb-4 text-center font-extrabold text-xl shadow-lg"></div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                <div class="p-3 bg-gray-900 rounded-lg border-b-4 border-gray-600">
                    <p class="text-xs font-medium text-gray-400">Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</p>
                    <p id="current-asset-display" class="text-lg font-bold text-white mt-1">XAUUSD / $0.00</p>
                </div>
                
                <div class="p-3 bg-indigo-900 rounded-lg border-b-4 border-indigo-500">
                    <p class="text-xs font-medium text-indigo-300">Ù†Ù‚Ø·Ù‡ ÙˆØ±ÙˆØ¯ (Entry)</p>
                    <p id="entry-price-display" class="text-lg font-bold text-white mt-1">$0.00</p>
                </div>
                
                <div class="p-3 bg-red-900 rounded-lg border-b-4 border-red-600">
                    <p class="text-xs font-medium text-red-300">Ø­Ø¯ Ø¶Ø±Ø± (Stop Loss)</p>
                    <p id="stop-loss-display" class="text-lg font-bold text-white mt-1">$0.00</p>
                </div>
                
                <div class="p-3 bg-green-900 rounded-lg border-b-4 border-green-600">
                    <p class="text-xs font-medium text-green-300">Ø­Ø¯ Ø³ÙˆØ¯ (Take Profit)</p>
                    <p id="take-profit-display" class="text-lg font-bold text-white mt-1">$0.00</p>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-3 text-center">** Ù†Ø³Ø¨Øª Ø±ÛŒØ³Ú© Ø¨Ù‡ Ø±ÛŒÙˆØ§Ø±Ø¯: Û± Ø¨Ù‡ Û±.Ûµ</p>
        </div>

        <!-- Historical Analysis Table -->
        <div id="signal-table-container" class="hidden mt-6">
            <h2 class="text-xl font-bold text-white mb-3 border-b border-gray-600 pb-2">Ø³ÙˆØ§Ø¨Ù‚ ØªØ­Ù„ÛŒÙ„ RSI Ùˆ EMA</h2>
            <div class="overflow-x-auto rounded-xl shadow-lg border border-gray-700">
                <table class="min-w-full divide-y divide-gray-600">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-400">Ú©Ù†Ø¯Ù„ #</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-400">Ù‚ÛŒÙ…Øª</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-400">RSI</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-400">EMA (5)</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-400">ÙˆØ¶Ø¹ÛŒØª</th>
                        </tr>
                    </thead>
                    <tbody id="signal-body" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Citation Sources -->
        <div id="citations-container" class="mt-6 p-3 bg-gray-900 rounded-lg hidden border border-gray-700">
            <p class="font-semibold text-xs text-gray-300 mb-1">ğŸ”— Ù…Ù†Ø§Ø¨Ø¹:</p>
            <ul id="sources-list" class="list-disc pr-5 text-xs text-gray-400 space-y-1"></ul>
        </div>
    </div>

    <!-- START OF JAVASCRIPT LOGIC -->
    <script>
        // API Configuration 
        const API_KEY = ""; // Ú©Ù„ÛŒØ¯ API Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
        const R_R_RATIO = 1.5; 
        const DATA_POINTS = 100; 
        const EMA_PERIOD = 5; 
        const MAX_HISTORY = 6; 
        const POPULAR_SYMBOLS = [
            "BTCUSD", "ETHUSD", "SOLUSD", "BNBUSD", "EURUSD", "GBPUSD", "XAUUSD", "XAGUSD"
        ];
        
        let signalHistory = [];

        // --- Utility Functions ---

        function toggleLoading(isLoading) {
            const button = document.getElementById('run-button');
            const buttonText = document.getElementById('button-text');
            const loader = document.getElementById('loader');
            
            button.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...' : 'Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ§Ù‚Ø¹ÛŒ';
            loader.classList.toggle('hidden', !isLoading);
        }

        function alertUser(message, classes) {
            const container = document.getElementById('app');
            const existingAlert = document.getElementById('temp-alert');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'temp-alert';
            const finalClasses = `${classes} mb-4 transition duration-300 p-4 rounded-xl shadow-md font-semibold text-center`;
            alertDiv.className = finalClasses.replace('bg-red-100', 'bg-red-900').replace('text-red-800', 'text-red-300');
            alertDiv.innerHTML = `<p>${message}</p>`;
            
            container.prepend(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 7000);
        }

        function selectSymbol(symbol) {
            document.getElementById('asset-symbol').value = symbol;
            document.getElementById('symbol-suggestions').classList.add('hidden');
        }

        function handleSearchInput(inputValue) {
            const input = inputValue.toUpperCase().trim();
            const suggestionsContainer = document.getElementById('symbol-suggestions');
            
            const filteredSymbols = POPULAR_SYMBOLS.filter(symbol => 
                symbol.startsWith(input) || symbol.includes(input)
            );

            suggestionsContainer.innerHTML = '';

            if (filteredSymbols.length > 0 && input.length >= 0) {
                 suggestionsContainer.classList.remove('hidden');
                filteredSymbols.slice(0, 7).forEach(symbol => {
                    const item = document.createElement('div');
                    item.className = 'p-2 hover:bg-indigo-600 cursor-pointer text-left text-white text-xs uppercase transition duration-150';
                    item.textContent = symbol;
                    item.onmousedown = (e) => { e.preventDefault(); selectSymbol(symbol); };
                    suggestionsContainer.appendChild(item);
                });
            } else {
                 suggestionsContainer.classList.add('hidden');
            }
        }

        // --- Technical Analysis ---
        function calculateEMA(prices, period) {
            if (prices.length < period) return Array(prices.length).fill(NaN);
            const emas = new Array(prices.length).fill(NaN);
            const multiplier = 2 / (period + 1);
            let sum = 0;
            for (let i = 0; i < period; i++) sum += prices[i];
            emas[period - 1] = sum / period;
            for (let i = period; i < prices.length; i++) {
                emas[i] = (prices[i] - emas[i - 1]) * multiplier + emas[i - 1];
            }
            return emas;
        }

        function calculateRSI(prices, period) {
            if (prices.length < period + 1) return Array(prices.length).fill(NaN);
            const changes = [];
            for (let i = 1; i < prices.length; i++) changes.push(prices[i] - prices[i - 1]);
            const rsis = Array(prices.length).fill(NaN);
            let avgGain = 0;
            let avgLoss = 0;

            for (let i = 0; i < period; i++) {
                if (changes[i] > 0) avgGain += changes[i];
                else avgLoss += Math.abs(changes[i]);
            }
            avgGain /= period;
            avgLoss /= period;
            
            let rs = avgLoss === 0 ? Infinity : avgGain / avgLoss;
            rsis[period] = 100 - (100 / (1 + rs));
            
            for (let i = period + 1; i < prices.length; i++) {
                const currentChange = changes[i - 1]; 
                let currentGain = 0;
                let currentLoss = 0;

                if (currentChange > 0) currentGain = currentChange;
                else currentLoss = Math.abs(currentChange);

                avgGain = (avgGain * (period - 1) + currentGain) / period;
                avgLoss = (avgLoss * (period - 1) + currentLoss) / period;

                rs = avgLoss === 0 ? Infinity : avgGain / avgLoss;
                rsis[i] = 100 - (100 / (1 + rs));
            }
            return rsis;
        }
        
        function determineMainSignal(rsi) {
            if (rsi < 30) return { action: 'BUY', color: 'green', text: 'âœ… Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯ Ø§ØµÙ„ÛŒ: Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´' };
            if (rsi > 70) return { action: 'SELL', color: 'red', text: 'âŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´ Ø§ØµÙ„ÛŒ: Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯' };
            return { action: 'HOLD', color: 'gray', text: 'Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ (Ø®Ù†Ø«ÛŒ)' };
        }
        
        function determineScalpingSignal(price, ema, rsi, timeframe) {
            if (isNaN(ema) || isNaN(rsi)) return { action: 'NONE', text: 'Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§Ø³Ú©Ø§Ù„Ù¾ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.' };
            
            // BUY: Price above EMA(5) AND RSI in range (30-65)
            if (price > ema && rsi > 30 && rsi < 65) {
                return { action: 'SCALP-BUY', text: `ğŸš€ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§Ø³Ú©Ø§Ù„Ù¾ Ø®Ø±ÛŒØ¯ Ø¯Ø± ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… ${timeframe}: Ù…ÙˆÙ…Ù†ØªÙˆÙ… ØµØ¹ÙˆØ¯ÛŒ (Price > EMA)` };
            } 
            
            // SELL: Price below EMA(5) AND RSI in range (35-70)
            if (price < ema && rsi > 35 && rsi < 70) {
                return { action: 'SCALP-SELL', text: `ğŸ”» Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§Ø³Ú©Ø§Ù„Ù¾ ÙØ±ÙˆØ´ Ø¯Ø± ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… ${timeframe}: Ù…ÙˆÙ…Ù†ØªÙˆÙ… Ù†Ø²ÙˆÙ„ÛŒ (Price < EMA)` };
            } 
            
            return { action: 'NONE', text: `Ø¨Ø¯ÙˆÙ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§Ø³Ú©Ø§Ù„Ù¾ ÙØ¹Ø§Ù„ Ø¯Ø± ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… ${timeframe}.` };
        }

        function calculateTradePoints(entryPrice, signalAction, riskPercent) {
            const riskAmount = entryPrice * (riskPercent / 100);
            const rewardAmount = riskAmount * R_R_RATIO; 
            let stopLoss, takeProfit;

            if (signalAction.includes('BUY')) {
                stopLoss = entryPrice - riskAmount;
                takeProfit = entryPrice + rewardAmount;
            } else if (signalAction.includes('SELL')) {
                stopLoss = entryPrice + riskAmount;
                takeProfit = entryPrice - rewardAmount;
            } else {
                return { stopLoss: null, takeProfit: null };
            }
            
            let precision = 4;
            if (entryPrice > 1000) precision = 2;
            else if (entryPrice < 0.1) precision = 6;
            else if (entryPrice < 1) precision = 5;

            return {
                stopLoss: parseFloat(stopLoss.toFixed(precision)),
                takeProfit: parseFloat(takeProfit.toFixed(precision)),
                entry: entryPrice
            };
        }

        // --- API and Data ---
        async function fetchMarketData(assetSymbol, timeframe) {
            // Ø§ÛŒÙ† Ù‚Ø³Ù…ØªØŒ Ú©Ù‡ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API Ø¨Ù‡ Gemini Ø§Ø³ØªØŒ Ø¨Ù‡ Ø§Ø­ØªÙ…Ø§Ù„ Ø²ÛŒØ§Ø¯ Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ¨Ù„Ø§Ú¯ Ø¨Ù„Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            // Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø¯Ù„ÛŒÙ„ØŒ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± ÛŒÚ© Ù‡Ø§Ø³Øª Ù…Ø¬Ø²Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.
            const systemPrompt = "You are a market analyst. Find the most current spot price of the requested financial asset (cryptocurrency, forex pair, or commodity). Respond only with the price number in USD (or its base currency value, e.g., for EURUSD, the EUR value in USD) without any text, currency symbol, or formatting. If it's a forex pair like EURUSD, return the current exchange rate number.";
            const userQuery = `Current spot price of ${assetSymbol}. Analyze this price considering the ${timeframe} chart context.`; 
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            let currentPrice = null;
            let sources = [];
            const MAX_RETRIES = 5;
            let delay = 1000;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const rawText = candidate.content.parts[0].text.trim();
                        const priceMatch = rawText.match(/(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/);
                        
                        if (priceMatch && priceMatch[1]) {
                            const parsedPrice = parseFloat(priceMatch[1].replace(/,/g, ''));
                            if (!isNaN(parsedPrice) && parsedPrice > 0) currentPrice = parsedPrice;
                        }

                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                                .filter(source => source.uri && source.title);
                        }
                        
                        if (currentPrice !== null) return { currentPrice, sources }; 
                    }
                    
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed, retrying...`, error);
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        // Throw on final failure
                        throw new Error("ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ ÙˆØ¨Ù„Ø§Ú¯ ÛŒØ§ Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·.");
                    }
                }
            }
            throw new Error("Ù†ØªÙˆØ§Ù†Ø³Øª Ù‚ÛŒÙ…Øª Ù…Ø¹ØªØ¨Ø± Ø±Ø§ Ø§Ø² Ù¾Ø§Ø³Ø® Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (Ù…Ø«Ù„ BTCUSD ÛŒØ§ EURUSD) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
        }
        
        function generateTrendPrices(count, finalPrice) {
             if (count < 2) return [finalPrice];
            let prices = new Array(count).fill(0);
            prices[count - 1] = finalPrice;
            let startPrice = finalPrice * (1 + (Math.random() - 0.5) * 0.01); 
            
            let precision = 8; 
            if (finalPrice > 1000) precision = 2;
            if (finalPrice > 1 && finalPrice <= 1000) precision = 4;
            if (finalPrice < 0.1) precision = 6;
            
            prices[0] = parseFloat(startPrice.toFixed(precision)); 

            for (let i = 1; i < count - 1; i++) {
                const prevPrice = prices[i - 1];
                const change = (Math.random() - 0.5) * 0.2; 
                let newPrice = prevPrice * (1 + change / 100);
                prices[i] = parseFloat(newPrice.toFixed(precision));
            }
            
            prices[count - 1] = finalPrice;
            return prices;
        }

        // --- UI Updates ---
        
        function updateHistoryCard() {
            const historyCard = document.getElementById('history-card');
            const historyDisplay = document.getElementById('history-display');
            historyDisplay.innerHTML = ''; 

            if (signalHistory.length === 0) {
                historyCard.classList.add('hidden');
                return;
            }
            
            historyCard.classList.remove('hidden');
            
            signalHistory.forEach(signal => {
                let actionColor = 'bg-gray-700 text-gray-300';
                if (signal.action.includes('BUY')) actionColor = 'bg-green-700 text-green-200';
                else if (signal.action.includes('SELL')) actionColor = 'bg-red-700 text-red-200';

                const cardHtml = `
                    <div class="p-3 rounded-lg bg-amber-800 border-b-4 border-amber-600 shadow-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-amber-200 uppercase text-xs">${signal.symbol}</span>
                            <span class="text-xs text-amber-400">${signal.time}</span>
                        </div>
                        <p class="text-md font-bold text-white">${signal.entry}</p>
                        <span class="px-2 py-0.5 mt-2 inline-flex text-xs leading-5 font-semibold rounded ${actionColor}">
                            ${signal.action.replace('SCALP-', '')}
                        </span>
                    </div>
                `;
                historyDisplay.innerHTML += cardHtml;
            });
        }

        function updateUI(assetSymbol, timeframe, prices, rsis, emas, tradePoints, mainSignal, scalpingSignal, sources) {
            document.getElementById('initial-message').classList.add('hidden');
            document.getElementById('recommendation-card').classList.remove('hidden');
            document.getElementById('signal-table-container').classList.remove('hidden');

            const finalPrice = prices[prices.length - 1];
            
            const signalDisplay = document.getElementById('signal-display');
            signalDisplay.textContent = mainSignal.text;
            
            if (mainSignal.action === 'BUY') {
                signalDisplay.className = 'p-3 text-white rounded-xl mb-4 text-center font-extrabold text-xl shadow-lg bg-green-600';
            } else if (mainSignal.action === 'SELL') {
                signalDisplay.className = 'p-3 text-white rounded-xl mb-4 text-center font-extrabold text-xl shadow-lg bg-red-600';
            } else {
                signalDisplay.className = 'p-3 text-white rounded-xl mb-4 text-center font-extrabold text-xl shadow-lg bg-gray-500';
            }
            
            const scalpingDisplay = document.getElementById('scalping-signal-display');
            scalpingDisplay.textContent = scalpingSignal.text;
            
            let decimalPlaces = 2; 
            if (finalPrice < 1) decimalPlaces = 5;
            if (finalPrice >= 1 && finalPrice < 1000) decimalPlaces = 4;
            if (finalPrice > 10000) decimalPlaces = 2;

            const formatOptions = { minimumFractionDigits: 2, maximumFractionDigits: decimalPlaces };
            const currencySymbol = assetSymbol.includes('USD') || assetSymbol.includes('XAU') || assetSymbol.includes('XAG') ? '$' : '';

            document.getElementById('current-asset-display').textContent = `${assetSymbol} (${timeframe}) / ${currencySymbol}${finalPrice.toLocaleString('en-US', formatOptions)}`;
            
            document.getElementById('entry-price-display').textContent = `${currencySymbol}${tradePoints.entry.toLocaleString('en-US', formatOptions)}`;
            
            document.getElementById('stop-loss-display').textContent = tradePoints.stopLoss ? `${currencySymbol}${tradePoints.stopLoss.toLocaleString('en-US', formatOptions)}` : 'N/A';
            document.getElementById('take-profit-display').textContent = tradePoints.takeProfit ? `${currencySymbol}${tradePoints.takeProfit.toLocaleString('en-US', formatOptions)}` : 'N/A';
            
            // Table update
            const tableBody = document.getElementById('signal-body');
            tableBody.innerHTML = ''; 
            const startIndex = Math.max(0, prices.length - 15); 

            for (let i = startIndex; i < prices.length; i++) {
                const price = prices[i];
                const rsi = rsis[i];
                const ema = emas[i];
                const isRealPrice = (i === prices.length - 1);
                
                const signal = rsi ? determineMainSignal(rsi) : { action: 'N/A', class: 'bg-gray-100 text-gray-800', text: 'N/A' };
                const rsiDisplay = isNaN(rsi) ? 'N/A' : rsi.toFixed(2);
                const emaDisplay = isNaN(ema) ? 'N/A' : ema.toLocaleString('en-US', formatOptions);
                const priceDisplay = price.toLocaleString('en-US', formatOptions);

                const row = `
                    <tr class="hover:bg-gray-700 ${isRealPrice ? 'bg-indigo-900 font-bold shadow-inner' : ''}">
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-300">${i + 1}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-300" dir="ltr">${priceDisplay} ${isRealPrice ? `(${currencySymbol}Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ)` : ''}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs ${rsi < 30 ? 'text-green-500' : rsi > 70 ? 'text-red-500' : 'text-gray-400'}">${rsiDisplay}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs ${isRealPrice && price > ema ? 'text-green-500' : isRealPrice && price < ema ? 'text-red-500' : 'text-gray-400'}" dir="ltr">${emaDisplay}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${signal.action === 'BUY' ? 'bg-green-700 text-green-200' : signal.action === 'SELL' ? 'bg-red-700 text-red-200' : 'bg-gray-600 text-gray-300'}">
                                ${signal.action}
                            </span>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }

            // Sources update
            const sourcesList = document.getElementById('sources-list');
            sourcesList.innerHTML = '';
            if (sources.length > 0) {
                sources.forEach(source => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-400 hover:underline transition">${source.title}</a>`;
                    sourcesList.appendChild(listItem);
                });
                document.getElementById('citations-container').classList.remove('hidden');
            } else {
                document.getElementById('citations-container').classList.add('hidden');
            }
            
            updateHistoryCard();
        }

        // --- Main Bot Logic ---
        async function runBot() {
            toggleLoading(true);
            
            document.getElementById('recommendation-card').classList.add('hidden');
            document.getElementById('signal-table-container').classList.add('hidden');
            document.getElementById('citations-container').classList.add('hidden');
            document.getElementById('initial-message').classList.remove('hidden');

            try {
                const assetSymbol = document.getElementById('asset-symbol').value.toUpperCase().trim();
                const timeframe = document.getElementById('timeframe-select').value; 
                const period = parseInt(document.getElementById('rsi-period').value);
                const riskPercent = parseFloat(document.getElementById('risk-percent').value);

                if (!assetSymbol) throw new Error("Ù„Ø·ÙØ§Ù‹ Ù†Ù…Ø§Ø¯ Ù…Ø§Ù„ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
                
                // *** Ø§ÛŒÙ† Ø®Ø· Ø¨Ù‡ Ø§Ø­ØªÙ…Ø§Ù„ Ø²ÛŒØ§Ø¯ ØªÙˆØ³Ø· ÙˆØ¨Ù„Ø§Ú¯ Ø¨Ù„Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯ ***
                const { currentPrice, sources } = await fetchMarketData(assetSymbol, timeframe); 

                if (!currentPrice || currentPrice <= 0) throw new Error(`Ù‚ÛŒÙ…Øª ${assetSymbol} Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.`);
                
                const prices = generateTrendPrices(DATA_POINTS, currentPrice);

                const rsis = calculateRSI(prices, period);
                const emas = calculateEMA(prices, EMA_PERIOD); 
                
                const finalRSI = rsis[prices.length - 1];
                const finalEMA = emas[prices.length - 1];

                const mainSignal = determineMainSignal(finalRSI);
                const scalpingSignal = determineScalpingSignal(currentPrice, finalEMA, finalRSI, timeframe);
                
                let effectiveSignalAction = 'HOLD';
                if (mainSignal.action !== 'HOLD') {
                    effectiveSignalAction = mainSignal.action;
                } else if (scalpingSignal.action === 'SCALP-BUY') {
                    effectiveSignalAction = 'BUY';
                } else if (scalpingSignal.action === 'SCALP-SELL') {
                    effectiveSignalAction = 'SELL';
                }

                let tradePoints = {};
                tradePoints.entry = currentPrice;

                if (effectiveSignalAction !== 'HOLD') {
                    tradePoints = { ...tradePoints, ...calculateTradePoints(currentPrice, effectiveSignalAction, riskPercent) };
                } else {
                    tradePoints.stopLoss = null;
                    tradePoints.takeProfit = null;
                }
                
                if (effectiveSignalAction !== 'HOLD') {
                    let precision = 4;
                    if (currentPrice > 1000) precision = 2;
                    else if (currentPrice < 0.1) precision = 6;
                    else if (currentPrice < 1) precision = 5;
                    const formatOptions = { minimumFractionDigits: 2, maximumFractionDigits: precision };
                    const currencySymbol = assetSymbol.includes('USD') || assetSymbol.includes('XAU') || assetSymbol.includes('XAG') ? '$' : '';

                    const signalType = effectiveSignalAction === mainSignal.action ? effectiveSignalAction : scalpingSignal.action;
                    
                    const signalToStore = {
                        symbol: assetSymbol,
                        action: signalType,
                        entry: `${currencySymbol}${currentPrice.toLocaleString('en-US', formatOptions)}`,
                        time: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }),
                    };
                    
                    signalHistory.unshift(signalToStore);
                    if (signalHistory.length > MAX_HISTORY) {
                        signalHistory = signalHistory.slice(0, MAX_HISTORY);
                    }
                }

                updateUI(assetSymbol, timeframe, prices, rsis, emas, tradePoints, mainSignal, scalpingSignal, sources);

            } catch (error) {
                console.error("Critical Bot Error:", error);
                // Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ø®Ø§Øµ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· ÙˆØ¨Ù„Ø§Ú¯
                if (error.message.includes('HTTP error') || error.message.includes('API Ù†Ø§Ù…ÙˆÙÙ‚')) {
                    alertUser("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯: Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ù¾Ù„ØªÙØ±Ù… ÙˆØ¨Ù„Ø§Ú¯ØŒ Ø§Ù…Ú©Ø§Ù† Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ API ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø§Ø¨Ø²Ø§Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø¯Ø± Ù‡Ø§Ø³Øª Ù…Ø¬Ø²Ø§ (Ø§Ø² Ø·Ø±ÛŒÙ‚ iFrame) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", "bg-red-900 text-red-300");
                } else {
                    alertUser(`Ø®Ø·Ø§: ${error.message}.`, "bg-red-900 text-red-300");
                }
                document.getElementById('initial-message').classList.remove('hidden');
            } finally {
                toggleLoading(false);
            }
        }
        
        window.onload = function() {
            document.getElementById('timeframe-select').value = 'M30'; 
            updateHistoryCard(); 
        };

    </script>
    <!-- END OF JAVASCRIPT LOGIC -->
</body>
</html>